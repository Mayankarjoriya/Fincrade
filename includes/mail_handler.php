<?phpuse PHPMailer\PHPMailer\PHPMailer;use PHPMailer\PHPMailer\Exception;require_once __DIR__ . '/../config/database.php';// Pehle email_config include kareinif (file_exists(__DIR__ . '/../config/email_config.php')) {    require_once __DIR__ . '/../config/email_config.php';} else {    // Agar config file nahi mila, toh default localhost mode on rakho    define('IS_LOCALHOST', true);}// --- PHPMailer Dependencies (Live Server Only) ---// Sirf tabhi include karenge jab yeh LIVE server par hoif (!IS_LOCALHOST) {    require_once __DIR__ . '/../vendor/autoload.php'; // Composer Autoloader}class MailHandler {    private $conn;    private $settings;    private $senderEmail = SMTP_FROM_EMAIL;        public function __construct() {        $database = new Database();        $this->conn = $database->getConnection();        $this->loadSettings();    }        private function loadSettings() {        try {            $query = "SELECT setting_key, setting_value FROM settings";            $stmt = $this->conn->prepare($query);            $stmt->execute();                        $this->settings = [];            while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {                $this->settings[$row['setting_key']] = $row['setting_value'];            }        } catch(PDOException $exception) {            $this->settings = [];        }    }    // ... (previous functions like loadSettings) ...    /**     * Send email using PHPMailer (Live) or log to file (Localhost)     * Ab yeh function aapki requirement ke anusaar Localhost/Live par switch karega.     */    public function sendMail($to, $subject, $message, $isHtml = true) {        // -------------------------------------------------        // 1. LOCALHOST SIMULATION LOGIC (Development)        // -------------------------------------------------        if (IS_LOCALHOST) {            // Isse aapka dashboard crash nahi hoga aur aapko success dikhega            $logFile = __DIR__ . '/../simulated_emails.txt';            $logEntry = "--- SIMULATED EMAIL [" . date('Y-m-d H:i:s') . "] ---\n";            $logEntry .= "TO: $to\nSUBJECT: $subject\nBODY (Plain Text): " . (strip_tags($message) ?: 'HTML content skipped.') . "\n\n";            file_put_contents($logFile, $logEntry, FILE_APPEND);            // Console mein/error log mein bhi dikha dega            error_log("Email simulated (LOCALHOST) to $to. Logged to simulated_emails.txt");            return true; // Return true for dashboard success        }        // -------------------------------------------------        // 2. LIVE SERVER (PHPMailer SMTP) LOGIC        // -------------------------------------------------        $mail = new PHPMailer(true); // Passing 'true' enables exceptions        try {            // Server settings (From email_config.php)            $mail->isSMTP();            $mail->Host       = SMTP_HOST;            $mail->SMTPAuth   = true;            $mail->Username   = SMTP_USERNAME;            $mail->Password   = SMTP_PASSWORD;            // Gmail ke liye yeh settings required hain            $mail->SMTPSecure = PHPMailer::ENCRYPTION_STARTTLS;            $mail->Port       = SMTP_PORT;            // Recipients: Database settings ya default config use karein            $fromEmail = $this->settings['admin_email'] ?? SMTP_FROM_EMAIL;            $fromName = $this->settings['company_name'] ?? SMTP_FROM_NAME;            $mail->setFrom($fromEmail, $fromName);            $mail->addAddress($to);            // Content            $mail->isHTML($isHtml);            $mail->Subject = $subject;            $mail->Body    = $message;            $mail->AltBody = $isHtml ? strip_tags($message) : ''; // Plain text for non-HTML readers            // Send            $mail->send();            return true; // Success        } catch (Exception $e) {            // Live server par error ko log karein            error_log('PHPMailer Error to ' . $to . ': ' . $mail->ErrorInfo);            // Aur fail hone par false return karein            return false;        }    }    // ... (rest of the class functions like sendLeadConfirmation, getBaseUrl, etc.) ...//    OLD sendMail function//    New sendMail function for development// WARNING do not use this function for Production//    public function sendMail($to, $subject, $message, $isHtml = true) {//        $fromEmail = $this->senderEmail;//        // Settings se email nikalein ya default use karein////        $fromEmail = $this->settings['admin_email'] ?? 'mayankrajoriya2004@gmail.com';////        $headers = [];//        $headers[] = 'From: ' . $fromEmail;//        $headers[] = 'Reply-To: ' . $fromEmail;//        $headers[] = 'X-Mailer: PHP/' . phpversion();////        if ($isHtml) {//            $headers[] = 'Content-Type: text/html; charset=UTF-8';//        } else {//            $headers[] = 'Content-Type: text/plain; charset=UTF-8';//        }//        // Try sending email//        try {//            // @ sign error ko suppress karega agar localhost par mail server nahi hai//            $result = @mail($to, $subject, $message, implode("\r\n", $headers));////            // LOCALHOST FIX: Agar mail fail ho (jo localhost pe hoga), to file mein log karein//            if (!$result) {//                $logFile = __DIR__ . '/../simulated_emails.txt';//                $logEntry = "--- NEW EMAIL [" . date('Y-m-d H:i:s') . "] ---\n";//                $logEntry .= "To: $to\nSubject: $subject\nMessage: " . strip_tags($message) . "\n\n";//                file_put_contents($logFile, $logEntry, FILE_APPEND);////                return true; // Return true taaki dashboard pe "Success" dikhe//            }////            return $result;//        } catch (Exception $e) {//            // Error aane par bhi true return karein taaki system crash na ho//            return true;//        }//    }//    public function sendMail($to, $subject, $message, $isHtml = true) {////        try {////            $headers = [];////            $headers[] = 'From: ' . ($this->settings['company_email'] ?? 'noreply@fincrade.com');////            $headers[] = 'Reply-To: ' . ($this->settings['company_email'] ?? 'noreply@fincrade.com');////            $headers[] = 'X-Mailer: PHP/' . phpversion();////////            if ($isHtml) {////                $headers[] = 'Content-Type: text/html; charset=UTF-8';////            } else {////                $headers[] = 'Content-Type: text/plain; charset=UTF-8';////            }////////            return mail($to, $subject, $message, implode("\r\n", $headers));////        } catch(Exception $e) {////            error_log("Mail sending failed: " . $e->getMessage());////            return false;////        }////    }    public function sendLeadConfirmation($leadData) {        $subject = "Thank you for your interest - Fincrade";        $message = $this->getLeadConfirmationTemplate($leadData);        return $this->sendMail($leadData['email'], $subject, $message);    }        public function sendPartnerApplicationConfirmation($partnerData) {        $subject = "Partner Application Received - Fincrade";        $message = $this->getPartnerConfirmationTemplate($partnerData);        return $this->sendMail($partnerData['phone'] . '@example.com', $subject, $message); // Using phone as placeholder    }        public function sendPasswordResetEmail($email, $token, $userRole) {        $resetUrl = $this->getBaseUrl() . "/{$userRole}/reset-password.php?token=" . $token;        $subject = "Password Reset Request - Fincrade";        $message = $this->getPasswordResetTemplate($resetUrl);        return $this->sendMail($email, $subject, $message);    }        public function sendNewUserCredentials($email, $username, $password, $role) {        $subject = "Your Fincrade Account Credentials";        $message = $this->getNewUserTemplate($username, $password, $role);        return $this->sendMail($email, $subject, $message);    }        public function sendLeadAssignmentNotification($employeeEmail, $leadData) {        $subject = "New Lead Assigned - Fincrade";        $message = $this->getLeadAssignmentTemplate($leadData);        return $this->sendMail($employeeEmail, $subject, $message);    }        private function getLeadConfirmationTemplate($leadData) {        return "        <!DOCTYPE html>        <html>        <head>            <style>                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }                .container { max-width: 600px; margin: 0 auto; padding: 20px; }                .header { background: #0f766e; color: white; padding: 20px; text-align: center; }                .content { padding: 20px; background: #f9f9f9; }                .footer { padding: 20px; text-align: center; font-size: 12px; color: #666; }            </style>        </head>        <body>            <div class='container'>                <div class='header'>                    <h1>Thank You for Your Interest!</h1>                </div>                <div class='content'>                    <h2>Dear {$leadData['name']},</h2>                    <p>Thank you for your interest in our {$leadData['product']} services. We have received your application and our team will contact you shortly.</p>                                        <h3>Your Application Details:</h3>                    <ul>                        <li><strong>Product:</strong> {$leadData['product']}</li>                        <li><strong>Email:</strong> {$leadData['email']}</li>                        <li><strong>Phone:</strong> {$leadData['phone']}</li>                        <li><strong>City:</strong> " . ($leadData['city'] ?? 'Not specified') . "</li>                    </ul>                                        <p>Our expert will reach out to you within 24 hours to discuss your requirements and help you find the best loan solution.</p>                                        <p>For immediate assistance, please call us at " . ($this->settings['company_phone'] ?? '+91 82093 12454') . "</p>                </div>                <div class='footer'>                    <p>&copy; 2024 Fincrade. All rights reserved.</p>                </div>            </div>        </body>        </html>";    }        private function getPartnerConfirmationTemplate($partnerData) {        return "        <!DOCTYPE html>        <html>        <head>            <style>                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }                .container { max-width: 600px; margin: 0 auto; padding: 20px; }                .header { background: #0f766e; color: white; padding: 20px; text-align: center; }                .content { padding: 20px; background: #f9f9f9; }                .footer { padding: 20px; text-align: center; font-size: 12px; color: #666; }            </style>        </head>        <body>            <div class='container'>                <div class='header'>                    <h1>Partner Application Received</h1>                </div>                <div class='content'>                    <h2>Dear {$partnerData['pname']},</h2>                    <p>Thank you for your interest in becoming a Fincrade partner. We have received your application and our team will review it shortly.</p>                                        <h3>Your Application Details:</h3>                    <ul>                        <li><strong>Name:</strong> {$partnerData['pname']}</li>                        <li><strong>Phone:</strong> {$partnerData['pphone']}</li>                        <li><strong>City:</strong> " . ($partnerData['pcity'] ?? 'Not specified') . "</li>                        <li><strong>Experience:</strong> " . ($partnerData['pexp'] ?? 'Not specified') . "</li>                    </ul>                                        <p>Our partnership team will contact you within 2-3 business days to discuss the next steps.</p>                </div>                <div class='footer'>                    <p>&copy; 2024 Fincrade. All rights reserved.</p>                </div>            </div>        </body>        </html>";    }        private function getPasswordResetTemplate($resetUrl) {        return "        <!DOCTYPE html>        <html>        <head>            <style>                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }                .container { max-width: 600px; margin: 0 auto; padding: 20px; }                .header { background: #0f766e; color: white; padding: 20px; text-align: center; }                .content { padding: 20px; background: #f9f9f9; }                .button { display: inline-block; padding: 12px 24px; background: #0f766e; color: white; text-decoration: none; border-radius: 5px; margin: 10px 0; }                .footer { padding: 20px; text-align: center; font-size: 12px; color: #666; }            </style>        </head>        <body>            <div class='container'>                <div class='header'>                    <h1>Password Reset Request</h1>                </div>                <div class='content'>                    <p>You have requested a password reset for your Fincrade account.</p>                    <p>Click the button below to reset your password:</p>                    <p><a href='{$resetUrl}' class='button'>Reset Password</a></p>                    <p>If the button doesn't work, copy and paste this link into your browser:</p>                    <p>{$resetUrl}</p>                    <p><strong>This link will expire in 1 hour.</strong></p>                    <p>If you didn't request this password reset, please ignore this email.</p>                </div>                <div class='footer'>                    <p>&copy; 2024 Fincrade. All rights reserved.</p>                </div>            </div>        </body>        </html>";    }        private function getNewUserTemplate($username, $password, $role) {        $loginUrl = $this->getBaseUrl() . "/{$role}/login.php";        return "        <!DOCTYPE html>        <html>        <head>            <style>                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }                .container { max-width: 600px; margin: 0 auto; padding: 20px; }                .header { background: #0f766e; color: white; padding: 20px; text-align: center; }                .content { padding: 20px; background: #f9f9f9; }                .credentials { background: #fff; padding: 15px; border-left: 4px solid #0f766e; margin: 15px 0; }                .footer { padding: 20px; text-align: center; font-size: 12px; color: #666; }            </style>        </head>        <body>            <div class='container'>                <div class='header'>                    <h1>Welcome to Fincrade!</h1>                </div>                <div class='content'>                    <p>Your account has been created successfully. Here are your login credentials:</p>                                        <div class='credentials'>                        <p><strong>Username:</strong> {$username}</p>                        <p><strong>Password:</strong> {$password}</p>                        <p><strong>Role:</strong> " . ucfirst(str_replace('_', ' ', $role)) . "</p>                        <p><strong>Login URL:</strong> <a href='{$loginUrl}'>{$loginUrl}</a></p>                    </div>                                        <p><strong>Important:</strong> Please change your password after your first login for security reasons.</p>                                        <p>If you have any questions, please contact our support team.</p>                </div>                <div class='footer'>                    <p>&copy; 2024 Fincrade. All rights reserved.</p>                </div>            </div>        </body>        </html>";    }        private function getLeadAssignmentTemplate($leadData) {        return "        <!DOCTYPE html>        <html>        <head>            <style>                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }                .container { max-width: 600px; margin: 0 auto; padding: 20px; }                .header { background: #0f766e; color: white; padding: 20px; text-align: center; }                .content { padding: 20px; background: #f9f9f9; }                .footer { padding: 20px; text-align: center; font-size: 12px; color: #666; }            </style>        </head>        <body>            <div class='container'>                <div class='header'>                    <h1>New Lead Assigned</h1>                </div>                <div class='content'>                    <p>A new lead has been assigned to you:</p>                                        <h3>Lead Details:</h3>                    <ul>                        <li><strong>Name:</strong> {$leadData['name']}</li>                        <li><strong>Email:</strong> {$leadData['email']}</li>                        <li><strong>Phone:</strong> {$leadData['phone']}</li>                        <li><strong>Product:</strong> {$leadData['product']}</li>                        <li><strong>City:</strong> " . ($leadData['city'] ?? 'Not specified') . "</li>                    </ul>                                        <p>Please log in to your dashboard to view full details and begin processing this lead.</p>                </div>                <div class='footer'>                    <p>&copy; 2024 Fincrade. All rights reserved.</p>                </div>            </div>        </body>        </html>";    }    // Admin se Employee ko notification bhejne ka function    public function sendEmployeeNotification($employeeEmail, $leadData, $adminMessage) {        $subject = "Action Required: Lead Update - Fincrade";        // Email Body Template        $message = "        <html>        <head>            <style>                body { font-family: Arial, sans-serif; color: #333; }                .container { padding: 20px; border: 1px solid #ddd; border-radius: 5px; }                .header { background-color: #f59e0b; color: white; padding: 10px; text-align: center; }                .content { padding: 15px; }                .msg-box { background: #fff3cd; padding: 15px; border-left: 5px solid #ffc107; margin: 15px 0; }            </style>        </head>        <body>            <div class='container'>                <div class='header'>                    <h2>Action Required</h2>                </div>                <div class='content'>                    <p>Admin has sent you a notification regarding Lead: <strong>{$leadData['name']}</strong></p>                                        <div class='msg-box'>                        <strong>Message from Admin:</strong><br>                        " . nl2br(htmlspecialchars($adminMessage)) . "                    </div>                                        <h3>Lead Details:</h3>                    <ul>                        <li><strong>Product:</strong> {$leadData['product']}</li>                        <li><strong>Phone:</strong> {$leadData['phone']}</li>                        <li><strong>Current Status:</strong> " . ucfirst($leadData['status']) . "</li>                    </ul>                                        <p>Please login to your dashboard to update this lead.</p>                </div>            </div>        </body>        </html>";        // Email send karein (Existing sendMail function use karke)        return $this->sendMail($employeeEmail, $subject, $message);    }//    New TEMPLATE: Employee Notification    private function getEmployeeNotificationTemplate($leadData, $adminMessage) {        return "        <!DOCTYPE html>        <html>        <head>            <style>                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }                .container { max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }                .header { background: #f59e0b; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }                .content { padding: 20px; background: #fff; }                .message-box { background: #fff3cd; color: #856404; padding: 15px; border-left: 5px solid #ffeeba; margin: 15px 0; border-radius: 4px; }                .details { background: #f8f9fa; padding: 15px; margin-top: 15px; border-radius: 4px; border: 1px solid #e9ecef; }                .footer { padding: 20px; text-align: center; font-size: 12px; color: #666; border-top: 1px solid #eee; margin-top: 20px; }            </style>        </head>        <body>            <div class='container'>                <div class='header'>                    <h1>Action Required: Lead Update</h1>                </div>                <div class='content'>                    <p>Admin has sent you a notification regarding a lead assigned to you.</p>                                        <h3>Message from Admin:</h3>                    <div class='message-box'>                        " . nl2br(htmlspecialchars($adminMessage)) . "                    </div>                                        <div class='details'>                        <h4>Lead Details:</h4>                        <p><strong>Name:</strong> {$leadData['name']}</p>                        <p><strong>Product:</strong> {$leadData['product']}</p>                        <p><strong>Current Status:</strong> " . ucfirst(str_replace('_', ' ', $leadData['status'])) . "</p>                        <p><strong>Phone:</strong> {$leadData['phone']}</p>                    </div>                                        <p>Please log in to your dashboard immediately to update the status or take necessary action.</p>                </div>                <div class='footer'>                    <p>&copy; " . date('Y') . " Fincrade. All rights reserved.</p>                </div>            </div>        </body>        </html>";    }    private function getBaseUrl() {        $protocol = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http';        $host = $_SERVER['HTTP_HOST'] ?? 'localhost';        $path = dirname($_SERVER['SCRIPT_NAME'] ?? '/');        return $protocol . '://' . $host . $path;    }}?>